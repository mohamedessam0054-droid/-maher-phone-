<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBt90XB3t9_MLH8-73wcQpE7fm65Le06FE",
    authDomain: "maher-phone.firebaseapp.com",
    projectId: "maher-phone",
    storageBucket: "maher-phone.firebasestorage.app",
    messagingSenderId: "759903479842",
    appId: "1:759903479842:web:25c32cd6034b413dc4027b",
    measurementId: "G-YV7TS3LDDW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function genId(){return 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,9);}
  let guestId = localStorage.getItem('guestId');
  if(!guestId){guestId=genId();localStorage.setItem('guestId',guestId);}
  function getCart(){return JSON.parse(localStorage.getItem('cart-'+guestId)||'[]');}
  function saveCart(items){localStorage.setItem('cart-'+guestId,JSON.stringify(items));}

  function addToCart(product){
    const cart=getCart();
    const found=cart.find(p=>p.id===product.id);
    if(found)found.qty+=product.qty;
    else cart.push(product);
    saveCart(cart);
    renderCart();
  }

  function renderCart(){
    const cart=getCart();
    const container=document.getElementById('cart-items');
    if(!container)return;
    container.innerHTML='';
    cart.forEach(item=>{
      const el=document.createElement('div');
      el.innerText=`${item.name} - ${item.qty} × ${item.price}`;
      container.appendChild(el);
    });
  }

  async function checkout(name,phone,address){
    const cart=getCart();
    if(!cart.length){alert('السلة فاضية');return;}
    await db.collection('carts').doc(guestId).set({
      guestId,
      items: cart,
      name,
      phone,
      address,
      status:'new',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // افتح واتساب مع بيانات الطلب
    let text=`طلب جديد من ${name}%0Aرقم: ${phone}%0Aعنوان: ${address}%0Aسلة:%0A`;
    cart.forEach(i=>{text+=`${i.name} - ${i.qty} × ${i.price}%0A`;});
    window.open(https://wa.me/201110112115?text=${text},'_blank');
    localStorage.removeItem('cart-'+guestId);
    renderCart();
    alert('تم إرسال الطلب! سيتم فتح واتساب لإكمال التواصل.');
  }

  document.addEventListener('DOMContentLoaded',()=>{
    renderCart();
    const checkoutForm=document.getElementById('checkout-form');
    if(checkoutForm){
      checkoutForm.addEventListener('submit',(e)=>{
        e.preventDefault();
        const name=checkoutForm.querySelector('[name=name]').value;
        const phone=checkoutForm.querySelector('[name=phone]').value;
        const address=checkoutForm.querySelector('[name=address]').value;
        checkout(name,phone,address).catch(err=>{console.error(err);alert('حصل خطأ');});
      });
    }
  });
</script>
