<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
</head>
<body>
<h1>لوحة التحكم - الطلبات</h1>
<div id="orders-list">جارٍ التحميل...</div>

<!-- Firebase compat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.1/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.6.1/firebase-firestore-compat.min.js"></script>

<script>
// إعداد Firebase (مرة واحدة فقط)
const firebaseConfig = {
  apiKey: "AIzaSyBt90XB3t9_MLH8-73wcQpE7fm65Le06FE",
  authDomain: "maher-phone.firebaseapp.com",
  projectId: "maher-phone",
  storageBucket: "maher-phone.firebasestorage.app",
  messagingSenderId: "759903680635",
  appId: "1:759903680635:web:xxxxxxxxxxxxxxx"
};

// تشغيل Firebase مرة واحدة فقط
firebase.initializeApp(firebaseConfig);

// Firestore
const db = firebase.firestore();

// تحميل الطلبات
async function loadOrders() {
  const list = document.getElementById('orders-list');
  list.innerHTML = 'جارٍ التحميل...';

  let snap;
  try {
    snap = await db.collection('carts')
      .orderBy('createdAt', 'desc')
      .get();
  } catch (e) {
    list.innerHTML = '❌ خطأ في القراءة من Firestore:<br>' + e;
    return;
  }

  list.innerHTML = '';

  snap.forEach(doc => {
    const data = doc.data();
    const div = document.createElement('div');

    div.innerHTML = `
      <strong>${data.name || 'زائر'}</strong> — ${data.phone || ''} <br>
      <small>${data.address || ''}</small><br>
      <small>${data.createdAt ? data.createdAt.toDate() : ''}</small>
      <div>
        <button onclick="viewOrder('${doc.id}')">عرض السلة</button>
        <button onclick="setStatus('${doc.id}','processing')">قيد التنفيذ</button>
        <button onclick="setStatus('${doc.id}','done')">تم</button>
      </div>
      <hr>
    `;

    list.appendChild(div);
  });
}

// عرض طلب
window.viewOrder = async function(id) {
  const doc = await db.collection('carts').doc(id).get();
  if (!doc.exists) return alert("الطلب غير موجود");

  const data = doc.data();
  let html = `
    <h3>طلب ${data.name}</h3>
    <p>هاتف: ${data.phone}<br>عنوان: ${data.address}</p>
    <ul>
  `;

  data.items.forEach(i => {
    html += <li>${i.name} — ${i.qty} × ${i.price}</li>;
  });

  html += </ul><p>الحالة: ${data.status || "new"}</p>;

  const w = window.open("", "_blank");
  w.document.write(html);
};

// تغيير حالة الطلب
window.setStatus = async function(id, status) {
  await db.collection('carts').doc(id).update({ status });
  alert("تم التحديث");
  loadOrders();
};

document.addEventListener("DOMContentLoaded", loadOrders);
</script>

</body>
</html>
